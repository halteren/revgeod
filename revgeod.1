.\" Automatically generated by Pandoc 1.16.0.2
.\"
.TH "REVGEOD(8)/REVGEOC" "1" "" "User Manuals" ""
.hy
.SH NAME
.PP
revgeod \- reverse\-geo lookup daemon
.PP
revgeoc \- lookup client for revgeod
.SH SYNOPSIS
.PP
revgeod [\-v]
.PP
revgeoc stats|dump|lookup|kill|test
.SH DESCRIPTION
.PP
\f[I]revgeod\f[] is a reverse Geo lookup daemon thing, accessible via
HTTP and backed via OpenCage (https://opencagedata.com), our geocoder of
choice.
You\[aq]ll need an OpenCage API key exported into the environment, and
you can specify \f[I]revgeod\f[]\[aq]s listen IP address and port which
default to \f[C]127.0.0.1\f[] and \f[C]8865\f[] respectively.
.PP
The (curently hardcoded) \f[I]geocache\f[] directory must exist and be
writeable by the owner of the \f[I]rungeod\f[] process; that\[aq]s where
the LMDB database is stored.
\f[I]revgeod\f[] caches OpenCage\[aq]s responses (they explicitly permit
this):
.PP
\f[I]revgeoc\f[] is the client program which speaks HTTP to
\f[I]revgeod\f[].
.SH EXAMPLE
.IP
.nf
\f[C]
$\ curl\ \-i\ \[aq]http://127.0.0.1:8865/rev?lat=48.85593&lon=2.29431\[aq]
HTTP/1.1\ 200\ OK
Connection:\ Keep\-Alive
Content\-Length:\ 163
Content\-type:\ application/json
Date:\ Wed,\ 23\ Jan\ 2019\ 14:08:43\ GMT

{
\ \ \ \ "address":\ {
\ \ \ \ "village":\ "4\ r\ du\ Général\ Lambert,\ 75015\ Paris,\ France",
\ \ \ \ "locality":\ "Paris",
\ \ \ \ "cc":\ "FR",
\ \ \ \ "s":\ "opencage"
\ \ \ \ }
}
\f[]
.fi
.PP
A second query for the same location would respond with \f[C]lmdb\f[]
instead of \f[C]opencage\f[] as the source, indicating it\[aq]s been
cached.
.SH ENDPOINTS
.PP
All \f[I]revgeod\f[] API endpoints are obtained via GET requests, and
the client program \f[I]revgeoc\f[] uses the same words as its commands.
.SS \f[C]rev\f[]
.PP
The \f[C]/rev\f[] endpoint is used to perform a reverse\-geo lookup and
cache the positive result.
This endpoint supports the following query parameters:
.IP \[bu] 2
\f[C]lat=\f[] specify the latitude as a decimal (mandatory)
.IP \[bu] 2
\f[C]lon=\f[] specify the longitude as a decimal (mandatory)
.IP \[bu] 2
\f[C]app=\f[] specifies an "application" for which query statistics
should be collected (see \f[I]statistics\f[] below) (optional)
.SS \f[C]stats\f[]
.PP
\f[I]revgeod\f[] provides statistics on its \f[C]/stats\f[] endpoint,
and it collects counters by \f[I]application\f[] if the \f[C]app\f[]
query parameter is specified during lookups:
.IP
.nf
\f[C]
{
\ \ \ "stats":\ {
\ \ \ \ \ \ "_whoami":\ "revgeod.c",
\ \ \ \ \ \ "_version":\ "0.1.8",
\ \ \ \ \ \ "stats":\ 8,
\ \ \ \ \ \ "requests":\ 13647,
\ \ \ \ \ \ "geocode_failed":\ 9,
\ \ \ \ \ \ "opencage":\ 13624,
\ \ \ \ \ \ "lmdb":\ 23
\ \ \ },
\ \ \ "apps":\ {
\ \ \ \ \ \ "recorder":\ 13,
\ \ \ \ \ \ "clitest":\ 5,
\ \ \ \ \ \ "jp0":\ 2
\ \ \ },
\ \ \ "uptime":\ 381258,
\ \ \ "uptime_s":\ "4\ days,\ 9\ hours,\ 54\ mins",
\ \ \ "tst":\ 1544555424,
\ \ \ "db_path":\ "/usr/local/var/revgeod/geocache/",
\ \ \ "db_entries":\ 43756,
\ \ \ "db_size":\ 7532544
}
\f[]
.fi
.SS \f[C]dump\f[]
.PP
The \f[C]/dump\f[] endpoint produces a full dump of the underling
database in JSON format as an array of objects, each containing a
\f[I]geohash\f[], the cached address information, and \f[I]lat\f[] and
\f[I]lon\f[] elements which are the latitude and longitude respectively
which have been decoded from the entries\[aq] \f[I]geohash\f[].
Note that this means that the values are not those from which the entry
originally resulted.
.SS \f[C]lookup\f[]
.PP
This endpoint expects \f[C]geohash\f[] query parameter with a
\f[I]geohash\f[] of precision 8; the key is looked up in the database
and the JSON data or HTTP status code 404 are returned.
.SS \f[C]kill\f[]
.PP
Similarly to \f[C]lookup\f[], \f[C]/kill\f[] also expects a
\f[I]geohash\f[] and removes it from the database.
.SH OPTIONS
.PP
\f[I]revgeod\f[] understands the following global options.
.TP
.B \-v
show version information and exit
.RS
.RE
.SH ENVIRONMENT
.TP
.B \f[C]revgeo_verbose\f[]
if this variable is set when \f[I]revgeoc\f[] starts, the program
displays received HTTP headers
.RS
.RE
.TP
.B \f[C]OPENCAGE_APIKEY\f[]
this mandatory variable must be set in \f[I]revgeod\f[]\[aq]s
environment for it to do reverse geo lookups.
.RS
.RE
.TP
.B \f[C]REVGEO_IP\f[]
optionally sets the listen address for \f[I]revgeod\f[]; defaults to
\f[C]127.0.0.1\f[] and we strongly recommend this is not changed to
anything other than a loopback address.
.RS
.RE
.TP
.B \f[C]REVGEO_PORT\f[]
optionally sets the TCP listen port to something other than the default
\f[C]8865\f[].
.RS
.RE
.TP
.B \f[C]REVGEO_HOST\f[]
optionally sets the hostname/address for \f[I]revgeoc\f[]; defaults to
\f[C]127.0.0.1\f[] and \f[C]REVGEO_PORT\f[]
.RS
.RE
.SH REQUIREMENTS
.SS freebsd
.IP
.nf
\f[C]
$\ pkg\ install\ curl
$\ pkg\ install\ libmicrohttpd
$\ pkg\ install\ lmdb

$\ cat\ >\ config.mk\ <<EOF
#\ STATSDHOST=\ \ \ \ \ \ \ \ \ \ \ "127.0.0.1"
LMDB_DATABASE=\ "data/geocache/"
LISTEN_HOST=\ \ \ "127.0.0.1"
LISTEN_PORT=\ \ \ "8865"
INC\ =\ \ \ \ \ \ \ \ \ \ \ \-I/usr/local/include
LIBS\ =\ \ \ \ \ \ \ \ \ \ \-L\ /usr/local/lib
EOF
\f[]
.fi
.SS rhel/centos
.IP
.nf
\f[C]
yum\ install\ lmdb
\f[]
.fi
.SS debian
.IP
.nf
\f[C]
apt\-get\ install\ \ liblmdb\-dev\ lmdb\-utils\ curl\ libcurl3
\f[]
.fi
.SS macos
.IP
.nf
\f[C]
brew\ install\ curl
brew\ install\ jpmens/brew/revgeod
\f[]
.fi
.PP
This is documented here (https://github.com/jpmens/homebrew-brew), and
the homebrew version is typically kept in sync with this version.
.SS all
.IP \[bu] 2
libmicrohttpd (https://www.gnu.org/software/libmicrohttpd/)
.IP \[bu] 2
statsd\-c\-client (https://github.com/romanbsd/statsd-c-client)
(optional)
.SH CREDITS
.IP \[bu] 2
\f[C]json.[ch]\f[] by Joseph A.
Adams.
.IP \[bu] 2
uthash (https://troydhanson.github.io/uthash/), by Troy D.
Hanson.
.IP \[bu] 2
utstring (https://troydhanson.github.io/uthash/utstring.html), by Troy
D.
Hanson.
.SH AVAILABILITY
.PP
<https://github.com/jpmens/revgeod>
.SH AUTHOR
.PP
Jan\-Piet Mens <https://jpmens.net>
